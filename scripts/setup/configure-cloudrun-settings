#!/bin/bash
#
# This script configures Zulip settings for Cloud Run deployment
# It reads environment variables and configures the appropriate settings files

set -euo pipefail

SETTINGS_FILE="/etc/zulip/settings.py"
ZULIP_CONF="/etc/zulip/zulip.conf"

echo "Configuring Zulip for Cloud Run deployment..."

# Ensure the /etc/zulip directory exists
sudo mkdir -p /etc/zulip

# Create or update zulip.conf for production deployment
sudo tee "$ZULIP_CONF" > /dev/null << EOF
[machine]
deploy_type = production

[postgresql]
database_name = zulip
database_user = zulip
missing_dictionaries = true
EOF

# Create or update settings.py
sudo tee "$SETTINGS_FILE" > /dev/null << 'EOF'
# Zulip Cloud Run Configuration
# This file is auto-generated by the Cloud Run deployment process

# Import the base template
from zproject.prod_settings_template import *  # noqa: F403 isort: skip

import os

# Configure external hostname from Cloud Run environment
EXTERNAL_HOST = os.environ.get('EXTERNAL_HOST', 'localhost')

# Configure PostgreSQL database connection
if os.environ.get('POSTGRES_HOST'):
    REMOTE_POSTGRES_HOST = os.environ['POSTGRES_HOST']
    REMOTE_POSTGRES_PORT = os.environ.get('POSTGRES_PORT', '5432')
    REMOTE_POSTGRES_SSLMODE = os.environ.get('POSTGRES_SSLMODE', 'require')

# Configure email settings for Cloud Run
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'

# Security settings for Cloud Run
SECURE_SSL_REDIRECT = True
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')

# Session configuration for Cloud Run
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True

# Static files configuration for Cloud Run
STATIC_URL = '/static/'

# Set up allowed hosts from environment
ALLOWED_HOSTS = [
    # Allow Cloud Run service domain
    '.run.app',
    # Allow custom domains
    '.a.run.app',
    # Allow localhost for development
    'localhost',
    '127.0.0.1',
]

# Add environment-specific allowed hosts
if os.environ.get('ALLOWED_HOSTS'):
    ALLOWED_HOSTS.extend(os.environ['ALLOWED_HOSTS'].split(','))

# Configure logging for Cloud Run (logs go to stdout/stderr)
LOGGING_CONFIG = None
import logging.config
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s [%(levelname)s] %(name)s: %(message)s',
    handlers=[
        logging.StreamHandler()
    ]
)

# Environment-specific settings
ZULIP_ENVIRONMENT = os.environ.get('ZULIP_ENVIRONMENT', 'production')
if ZULIP_ENVIRONMENT == 'staging':
    DEBUG = False
    DEVELOPMENT = False
    # Add staging-specific configurations here

elif ZULIP_ENVIRONMENT == 'production':
    DEBUG = False
    DEVELOPMENT = False
    # Add production-specific configurations here

# Additional Cloud Run optimizations
# Disable features that don't work well in serverless environments
ZULIP_SERVICE_PUSH_NOTIFICATIONS = False
ZULIP_SERVICE_SUBMIT_USAGE_STATISTICS = False
EOF

echo "Cloud Run settings configured successfully."

# Set proper ownership and permissions
sudo chown zulip:zulip "$SETTINGS_FILE" "$ZULIP_CONF"
sudo chmod 644 "$SETTINGS_FILE" "$ZULIP_CONF"

echo "Settings files created with proper permissions."
