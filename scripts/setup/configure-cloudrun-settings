#!/bin/bash
#
# This script configures Zulip settings for Cloud Run deployment
# It reads environment variables and configures the appropriate settings files

set -euo pipefail

SETTINGS_FILE="/etc/zulip/settings.py"
ZULIP_CONF="/etc/zulip/zulip.conf"

echo "Configuring Zulip for Cloud Run deployment..."

# Ensure the /etc/zulip directory exists
sudo mkdir -p /etc/zulip

# Create or update zulip.conf for production deployment
if [ -n "${CLOUDSQL_INSTANCE:-}" ]; then
    # Cloud SQL unix socket configuration
    CLOUDSQL_SOCKET="/cloudsql/$CLOUDSQL_INSTANCE"
    echo "Configuring zulip.conf for Cloud SQL unix socket: $CLOUDSQL_SOCKET"
    
    sudo tee "$ZULIP_CONF" > /dev/null << EOF
[machine]
deploy_type = production

[postgresql]
database_name = zulip
database_user = zulip
missing_dictionaries = true
EOF
    
    # Set environment variables for the current session and export them
    # These will be used by Django when it imports the settings
    export REMOTE_POSTGRES_HOST="$CLOUDSQL_SOCKET"
    export REMOTE_POSTGRES_PORT=""
    export REMOTE_POSTGRES_SSLMODE="disable"
    
elif [ -n "${POSTGRES_HOST:-}" ]; then
    # Direct TCP connection configuration  
    echo "Configuring zulip.conf for direct PostgreSQL connection: $POSTGRES_HOST"
    
    sudo tee "$ZULIP_CONF" > /dev/null << EOF
[machine]
deploy_type = production

[postgresql]
database_name = zulip
database_user = zulip
missing_dictionaries = true
EOF

    # Set environment variables for direct TCP connection
    export REMOTE_POSTGRES_HOST="${POSTGRES_HOST}"
    export REMOTE_POSTGRES_PORT="${POSTGRES_PORT:-5432}"
    export REMOTE_POSTGRES_SSLMODE="${POSTGRES_SSLMODE:-require}"
    
else
    echo "No database configuration found, using default local configuration"
    sudo tee "$ZULIP_CONF" > /dev/null << EOF
[machine]
deploy_type = production

[postgresql]
database_name = zulip
database_user = zulip
missing_dictionaries = true
EOF
fi

# Create or update settings.py
sudo tee "$SETTINGS_FILE" > /dev/null << 'EOF'
# Zulip Cloud Run Configuration
# This file is auto-generated by the Cloud Run deployment process

# Import the base template
from zproject.prod_settings_template import *  # noqa: F403 isort: skip

import os

# Configure external hostname from Cloud Run environment
EXTERNAL_HOST = os.environ.get('EXTERNAL_HOST', 'localhost')

# Database configuration is handled by environment variables set above
# and Zulip's built-in computed_settings.py logic
# No need to override DATABASES here as Zulip will configure it automatically

import logging
logging.info("Using Zulip's built-in database configuration logic")
logging.info(f"REMOTE_POSTGRES_HOST: {os.environ.get('REMOTE_POSTGRES_HOST', 'Not set')}")
logging.info(f"REMOTE_POSTGRES_PORT: {os.environ.get('REMOTE_POSTGRES_PORT', 'Not set')}")
logging.info(f"REMOTE_POSTGRES_SSLMODE: {os.environ.get('REMOTE_POSTGRES_SSLMODE', 'Not set')}")

# Configure email settings for Cloud Run
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'

# Security settings for Cloud Run
SECURE_SSL_REDIRECT = True
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')

# Session configuration for Cloud Run
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True

# Static files configuration for Cloud Run
STATIC_URL = '/static/'

# Set up allowed hosts from environment
ALLOWED_HOSTS = [
    # Allow Cloud Run service domain
    '.run.app',
    # Allow custom domains
    '.a.run.app',
    # Allow localhost for development
    'localhost',
    '127.0.0.1',
]

# Add environment-specific allowed hosts
if os.environ.get('ALLOWED_HOSTS'):
    ALLOWED_HOSTS.extend(os.environ['ALLOWED_HOSTS'].split(','))

# Configure logging for Cloud Run (logs go to stdout/stderr)
LOGGING_CONFIG = None
import logging.config
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s [%(levelname)s] %(name)s: %(message)s',
    handlers=[
        logging.StreamHandler()
    ]
)

# Environment-specific settings
ZULIP_ENVIRONMENT = os.environ.get('ZULIP_ENVIRONMENT', 'production')
if ZULIP_ENVIRONMENT == 'staging':
    DEBUG = False
    DEVELOPMENT = False
    # Add staging-specific configurations here

elif ZULIP_ENVIRONMENT == 'production':
    DEBUG = False
    DEVELOPMENT = False
    # Add production-specific configurations here

# Additional Cloud Run optimizations
# Disable features that don't work well in serverless environments
ZULIP_SERVICE_PUSH_NOTIFICATIONS = False
ZULIP_SERVICE_SUBMIT_USAGE_STATISTICS = False
EOF

echo "Cloud Run settings configured successfully."

# Create an environment file with database settings
ENV_FILE="/etc/zulip/cloudrun.env"
echo "Creating environment file at $ENV_FILE..."

sudo tee "$ENV_FILE" > /dev/null << EOF
# Cloud Run environment variables for Zulip database configuration
# This file is sourced by the entrypoint script

# Database configuration environment variables
export REMOTE_POSTGRES_HOST="${REMOTE_POSTGRES_HOST:-}"
export REMOTE_POSTGRES_PORT="${REMOTE_POSTGRES_PORT:-}"
export REMOTE_POSTGRES_SSLMODE="${REMOTE_POSTGRES_SSLMODE:-}"

# Debug information
echo "[CloudRun] Database environment variables set:"
echo "[CloudRun] REMOTE_POSTGRES_HOST=$REMOTE_POSTGRES_HOST"
echo "[CloudRun] REMOTE_POSTGRES_PORT=$REMOTE_POSTGRES_PORT"
echo "[CloudRun] REMOTE_POSTGRES_SSLMODE=$REMOTE_POSTGRES_SSLMODE"
EOF

# Set proper ownership and permissions
sudo chown zulip:zulip "$SETTINGS_FILE" "$ZULIP_CONF" "$ENV_FILE"
sudo chmod 644 "$SETTINGS_FILE" "$ZULIP_CONF" "$ENV_FILE"

echo "Settings and environment files created with proper permissions."
